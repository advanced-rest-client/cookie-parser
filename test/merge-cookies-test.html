<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

</head>

<body>
  <script type="module">
  import {Cookies} from '../cookie-parser.js';
  suite('Parse cookies with base URL', function() {
    this.timeout(2500);

    let httpStr = 'rememberme=1; domain=foo.com;';
    httpStr += ' path=/; ssid=Hy1t5e#oj21.876aak;';
    const baseUrl = 'http://bar.com/';

    test('should merge when no old cookies', function() {
      const oldParser = new Cookies('', baseUrl);
      const newParser = new Cookies(httpStr, baseUrl);
      oldParser.merge(newParser);
      assert.lengthOf(oldParser.cookies, 2);
    });

    test('should merge when no new cookies, no old cookies', function() {
      const oldParser = new Cookies('', baseUrl);
      const newParser = new Cookies('', baseUrl);
      oldParser.merge(newParser);
      assert.lengthOf(oldParser.cookies, 0);
    });

    test('should merge when no new cookies', function() {
      const oldParser = new Cookies(httpStr, baseUrl);
      const newParser = new Cookies('', baseUrl);
      oldParser.merge(newParser);
      assert.lengthOf(oldParser.cookies, 2);
    });

    test('should merge different cookies', function() {
      const oldParser = new Cookies(httpStr, baseUrl);
      const newParser = new Cookies('test=value', baseUrl);
      oldParser.merge(newParser);
      assert.lengthOf(oldParser.cookies, 3);
    });

    test('should merge same cookies', function(done) {
      const pastCookies = new Cookies(httpStr, baseUrl);
      setTimeout(function() {
        const oldCookieCreationTime = pastCookies.cookies[1].created;
        const oldCookieLastAccessTime = pastCookies.cookies[1].lastAccess;
        const newParser = new Cookies('ssid=abc', baseUrl);
        pastCookies.merge(newParser);
        assert.lengthOf(pastCookies.cookies, 2, 'Old cookies are replaced');
        assert.equal(pastCookies.cookies[1].created, oldCookieCreationTime,
          'New cookie have old\'s creation time');
        assert.notEqual(pastCookies.cookies[1].lastAccess, oldCookieLastAccessTime,
          'New cookie should not have old\'s last access time');
        done();
      }, 1000);
    });

    test('should have new cookie value', function() {
      const oldParser = new Cookies(httpStr, baseUrl);
      const newParser = new Cookies('ssid=abc', baseUrl);
      oldParser.merge(newParser);
      assert.equal(oldParser.cookies[1].value, 'abc');
    });
  });
  </script>
</body>

</html>
