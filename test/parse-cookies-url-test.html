<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

</head>

<body>
  <script type="module">
  import {Cookies} from '../cookie-parser.js';
  suite('Parse cookies with base URL', function() {
    this.timeout(2500);

    let httpStr = 'rememberme=1; domain=foo.com;';
    httpStr += ' path=/; ssid=Hy1t5e#oj21.876aak;';
    const baseUrl = 'http://bar.com/';

    test('should set empty cookie\'s attributes domain and path', function() {
      const parser = new Cookies(httpStr, baseUrl);
      const cookie = parser.cookies[1];
      assert.equal(cookie.domain, 'bar.com', 'Do not set cookie domain');
      assert.equal(cookie.path, '/', 'Do not set cookie path');
    });

    test('should remove not matched cookies', function() {
      const parser = new Cookies(httpStr, baseUrl);
      const removed = parser.filter();
      assert.lengthOf(parser.cookies, 1, 'Remaining 1 cookie');
      assert.typeOf(removed, 'array', 'Removed is an array');
      assert.lengthOf(removed, 1, 'Removed has 1 item');
      assert.equal(removed[0].name, 'rememberme');
    });

    test('should not remove not expired cookies', function() {
      const parser = new Cookies(httpStr, baseUrl);
      const removed = parser.clearExpired();
      assert.lengthOf(parser.cookies, 2, 'Remaining 2 cookies');
      assert.typeOf(removed, 'array', 'Removed is an array');
      assert.lengthOf(removed, 0, 'Removed should be an empty array');
    });

    test('should remove expired cookies set by `expires`', function() {
      const str = httpStr + ' expires=' + new Date(Date.now() - 100).toUTCString();
      const parser = new Cookies(str, baseUrl);
      const removed = parser.clearExpired();
      assert.lengthOf(parser.cookies, 1,
        'Did not removed expired cookie set by `expires` attribute');
      assert.typeOf(removed, 'array', 'Removed is an array');
      assert.lengthOf(removed, 1, 'Removed has 1 item');
      assert.equal(removed[0].name, 'ssid');
    });

    test('should remove expired cookies set by `max-age`', function(done) {
      const str = httpStr + ' max-age=1';
      const parser = new Cookies(str, baseUrl);
      setTimeout(function() {
        const removed = parser.clearExpired();
        assert.lengthOf(parser.cookies, 1,
          'Did not removed expired cookie set by `max-age` attribute');
        assert.typeOf(removed, 'array', 'Removed is an array');
        assert.lengthOf(removed, 1, 'Removed has 1 item');
        assert.equal(removed[0].name, 'ssid');
        done();
      }, 1100); // max-age + 100ms
    });
  });
  </script>
</body>

</html>
